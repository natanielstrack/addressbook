{% block content %}
    <script>
        let addressMap = Object;

        function addFusiontablesLayer() {
            var layer = new google.maps.FusionTablesLayer({
                query: {
                    select: '\'Geocodable address\'',
                    from: '{{ fusion_table_id }}'
                }
            });
            layer.setMap(addressMap);
        }

        function showLocations(results=[]) {
            htmlList = '';

            results.map(function(location) {
                lat = parseFloat(location[2]);
                lng = parseFloat(location[1]);
                address = location[3];

                htmlList += `<li>(${lat}, ${lng}): ${address}</li>`;
            });

            htmlList = `<ul>${htmlList}</ul>`;
            $('#addressesList').html(htmlList);
            addFusiontablesLayer();
        }

        function handleRequests(url, data='') {
            $('#loader').css('display', 'block');
            $.ajax({
                url: url,
                method: "POST",
                data: data,
                headers: { 'X-CSRFToken':'{{ csrf_token }}' }
            }).done(function( data ) {
                showLocations(data.results);
            }).fail(function( data ) {
                alert(data.statusText);
            }).always(function( data ) {
                $('#loader').css('display', 'none');
            });
        }

        function deleteAdresses() {
            handleRequests('/delete');
        }

        function listLocations() {
            handleRequests('/list');
        }

        function addMapListeners() {
            google.maps.event.addListener(addressMap, 'click', function(event) {
                handleRequests('/add', event.latLng.toJSON());
            });
        }

        function initMap() {
            addressMap = new google.maps.Map(document.getElementById('map'), {
              zoom: 15,
              center: {lat: 47.3877746, lng: 8.5179263}
            });
            listLocations();
            addMapListeners();
        }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_geo_api_key }}&callback=initMap">
    </script>
{% endblock %}
